<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoadMap | Weekly Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --brand-blue: #2563eb; --bg-dark: #09090b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: #fafafa; }
        .grid-bg { background-image: radial-gradient(#27272a 1px, transparent 1px); background-size: 30px 30px; }
        
        /* Futuristic Table Styling */
        .table-container { overflow-x: auto; background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(10px); border: 1px solid #27272a; border-radius: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { background: #18181b; color: #3b82f6; text-transform: uppercase; letter-spacing: 0.1em; padding: 1rem; border-bottom: 2px solid #27272a; }
        td { padding: 0.75rem; border: 1px solid #27272a; text-align: center; vertical-align: top; min-width: 120px; }
        .time-col { background: #111113; font-weight: bold; color: #71717a; width: 80px; }
        .study-block { background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 4px; padding: 4px; margin-top: 2px; }

        /* AI ROBOT ANIMATION */
        .robot-box { position: fixed; top: 20px; right: 20px; text-align: center; z-index: 100; }
        .head { width: 60px; height: 50px; background: #020617; border: 2px solid #3b82f6; border-radius: 10px; position: relative; box-shadow: 0 0 15px #3b82f6; animation: float 3s ease-in-out infinite; }
        .eye { width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; position: absolute; top: 15px; }
        .eye.left { left: 12px; } .eye.right { right: 12px; }
        .thinking .eye { animation: pulseEye 0.5s infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulseEye { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } }
    </style>
</head>
<body class="min-h-screen grid-bg p-4 md:p-8">

    <div class="robot-box" id="aiBot">
        <div class="head thinking">
            <div class="eye left"></div>
            <div class="eye right"></div>
        </div>
        <div id="botStatus" class="text-[8px] text-blue-400 mt-2 uppercase font-bold tracking-widest">Constructing Schedule...</div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold tracking-tighter uppercase italic text-white">Dynamic <span class="text-blue-500">Timeline</span></h1>
                <p id="userName" class="text-zinc-500 text-sm italic uppercase tracking-widest"></p>
            </div>
            <button onclick="window.print()" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-[10px] font-bold rounded-lg transition border border-zinc-700">PRINT PDF</button>
        </header>

        <div class="table-container shadow-2xl">
            <table id="routineTable">
                <thead>
                    <tr>
                        <th class="time-col">Time</th>
                        <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
                    </tr>
                </thead>
                <tbody id="plannerBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // PASTE KEY HERE
        const userData = JSON.parse(localStorage.getItem('loadmap_data'));
        
        if (userData) document.getElementById('userName').textContent = `${userData.student} | ${userData.institution}`;

        // --- 2. THE AI PLANNER LOGIC ---
        async function generateAIPlan() {
            const body = document.getElementById('plannerBody');
            const botStatus = document.getElementById('botStatus');
            const botHead = document.querySelector('.head');

            const prompt = `Create a strict 24-hour timestamped study routine in JSON format. 
            Student can study ${userData.dailyHours} hours/day. 
            Subjects: ${JSON.stringify(userData.modules)}.
            
            Return ONLY a JSON array of objects with this structure:
            [ {"time": "08:00", "mon": "Subject A", "tue": "Subject B"...}, ... ]
            Fill the whole day from 06:00 to 23:00. Include breaks and sleep.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const result = await response.json();
                let text = result.candidates[0].content.parts[0].text;
                
                // Clean the AI response (remove markdown code blocks if present)
                const jsonStr = text.replace(/```json|```/gi, '').trim();
                const schedule = JSON.parse(jsonStr);

                // Build Table Rows
                body.innerHTML = '';
                schedule.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="time-col">${row.time}</td>
                        <td>${formatBlock(row.mon)}</td>
                        <td>${formatBlock(row.tue)}</td>
                        <td>${formatBlock(row.wed)}</td>
                        <td>${formatBlock(row.thu)}</td>
                        <td>${formatBlock(row.fri)}</td>
                        <td>${formatBlock(row.sat)}</td>
                        <td>${formatBlock(row.sun)}</td>
                    `;
                    body.appendChild(tr);
                });

                botStatus.textContent = "Optimization Complete";
                botHead.classList.remove('thinking');

            } catch (error) {
                console.error(error);
                botStatus.textContent = "Offline Mode Enabled";
                generateStaticFallback();
            }
        }

        function formatBlock(val) {
            if (!val || val === "Sleep" || val === "Break") return `<span class="opacity-30">${val || ''}</span>`;
            return `<div class="study-block text-[10px] font-bold">${val}</div>`;
        }

        // Emergency Fallback if AI Fails
        function generateStaticFallback() {
            const body = document.getElementById('plannerBody');
            for(let h=6; h<23; h++) {
                const time = `${h < 10 ? '0'+h : h}:00`;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="time-col">${time}</td>` + `<td>--</td>`.repeat(7);
                body.appendChild(tr);
            }
        }

        window.onload = generateAIPlan;
    </script>
</body>
</html>