<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gemini | Cognitive Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: #00ffb3; font-family: 'Orbitron', sans-serif; }
        .glass-panel { background: rgba(0, 20, 10, 0.8); border: 1px solid #00ffb3; box-shadow: 0 0 20px rgba(0, 255, 179, 0.2); }
        .loading-shimmer { background: linear-gradient(90deg, #001a11 25%, #00ffb333 50%, #001a11 75%); background-size: 200% 100%; animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="p-6 md:p-10">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl md:text-3xl mb-8 text-center tracking-widest uppercase font-bold">
            Neural Analysis <span class="text-white">Active</span>
        </h1>
        
        <div class="glass-panel p-6 rounded-2xl mb-8">
            <canvas id="loadChart" style="max-height: 400px;"></canvas>
        </div>

        <div id="aiInsightBox" class="glass-panel p-6 rounded-xl border-blue-500 mb-8 min-h-[100px]">
            <h3 class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-3 italic">Gemini Systems Report:</h3>
            <div id="aiContent" class="text-sm leading-relaxed text-zinc-300">
                <div class="loading-shimmer h-4 w-3/4 rounded mb-2"></div>
                <div id="statusText" class="text-[10px] animate-pulse">Initializing Neural Link...</div>
            </div>
        </div>

        <button onclick="generateFinalPlan()" id="planBtn" class="w-full py-5 bg-gradient-to-r from-blue-600 to-green-500 text-white font-bold rounded-xl transition shadow-lg uppercase tracking-[0.3em] opacity-50 cursor-not-allowed" disabled>
            Plan My Week
        </button>
    </div>

    <script>
        // 1. DATA RECOVERY
        const rawData = localStorage.getItem('loadmap_data');
        const data = JSON.parse(rawData);
        
        // PASTE YOUR API KEY HERE
        const API_KEY = "YOUR_GEMINI_API_KEY_HERE"; 

        // 2. CHART LOGIC
        function initChart() {
            if(!data || !data.modules) return;
            const ctx = document.getElementById('loadChart').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: data.modules.map(m => m.name),
                    datasets: [{
                        label: 'Stress Index',
                        data: data.modules.map(m => m.level === 'weak' ? 95 : (m.level === 'average' ? 65 : 35)),
                        backgroundColor: 'rgba(0, 255, 179, 0.2)',
                        borderColor: '#00ffb3',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: { r: { grid: { color: '#1a3a30' }, ticks: { display: false }, pointLabels: { color: '#00ffb3' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // 3. UNLOCK BUTTON UTILITY
        function unlockSystem() {
            const btn = document.getElementById('planBtn');
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.classList.add('hover:scale-105', 'active:scale-95', 'cursor-pointer');
        }

        // 4. THE ANALYSIS CALL
        async function getAnalysis() {
            const display = document.getElementById('aiContent');
            
            if (!API_KEY || API_KEY.includes("YOUR_API")) {
                display.innerHTML = "SYSTEM NOTE: No API Key detected. Running Local Heuristics... <br><br> Your profile suggests high density in " + data.modules[0].name + ". Recommend 90-minute focus blocks.";
                unlockSystem();
                return;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Analyze this student profile and give a 3-sentence engineering study strategy: ${JSON.stringify(data)}` }] }]
                    })
                });

                const result = await response.json();
                if(result.candidates) {
                    display.innerHTML = result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Limit Reached");
                }
            } catch (e) {
                display.innerHTML = "Neural Link Offline. Local Backup: Focus on 'Weak' modules first to flatten the stress curve.";
            } finally {
                unlockSystem();
            }
        }

        function generateFinalPlan() {
            window.location.href = 'planner.html';
        }

        window.onload = () => {
            if(!data) {
                alert("No data found. Redirecting to setup...");
                window.location.href = "setup.html";
                return;
            }
            initChart();
            getAnalysis();
        };
    </script>
</body>
</html>